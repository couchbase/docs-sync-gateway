= What's New
:idprefix:
:idseparator: -

== Views to GSI

Prior to 2.1, Sync Gateway used system views for a variety of internal operations, including authentication and replication.
Starting in 2.1, Sync Gateway will use GSI and N1QL to perform those tasks.
A key advantage of the switch to GSI is that it supports index replicas, allowing Sync Gateway to reduce the downtime during a server upgrade, rebalance or failover from several hours to a few seconds.
This change also improves overall query performance.
Note that this only impacts system views.
Users can continue to define views through the xref:admin-rest-api.adoc#/query[Sync Gateway Admin REST API].
This capability is enabled by default and there are 2 properties in the configuration file which can be adjusted:

* xref:config-properties.adoc#databases-foo_db-use_views[`databases.$db.use_views`]
* xref:config-properties.adoc#databases-foo_db-num_index_replicas[`databases.$db.num_index_replicas`]

NOTE: Use of GSI requires Couchbase Server 5.5, with at least one node running the Index Service.
Users wanting to run Sync Gateway 2.1 with an older version of Couchbase Server will need to continue to use views, by setting the `use_views` property.

NOTE: By default, Sync Gateway requires the Index Service to be running on at least two Couchbase Server nodes (required for index replica).
Users can run with a single Index Service node by setting Sync Gateway's `num_index_replicas` property to zero, but this may result in increased downtime in the event of an index node failure.

== X.509 Authentication against Couchbase Server

Sync Gateway adds the ability to use X.509 certificates to authenticate against Couchbase Server 5.5 or higher.
This functionality can be used instead or in addition to the existing authentication method which is to specify a username and password in the configuration file.

=== X.509 Certificates for Couchbase Server

In order to generate a certificate for Sync Gateway, you must first generate the cluster certificate and node certificates.
Instructions to create and install those certificates can be found https://developer.couchbase.com/documentation/server/current/security/security-x509certsintro.html#story-h2-2[here] (step 1 to 13).

=== X.509 Certificates for Sync Gateway

The client certificates need to be signed by the Couchbase cluster certificate.
So in order to generate certificates for Sync Gateway, we will use the output files from the previous section.

You should now have a folder called *SSLCA*. From the parent directory (i.e `../SSLCA`), follow the steps below.

. Create a new file called *ssl.conf* with the following.
+
[source,bash]
----
[ req ]
default_bits        = 2048
distinguished_name  = req_distinguished_name
req_extensions      = req_ext
prompt              = no

[ req_distinguished_name ]
countryName         = US
stateOrProvinceName = California
localityName        = San Jose
organizationName    = XYZ Inc
commonName          = travel-sample

[ req_ext ]
subjectAltName = @alt_names
[alt_names]
DNS.1   = node1-user1.xyz.com
DNS.2   = node1-user2.xyz.com
----
When using X.509 certificates for authentication, Couchbase Server searches for the RBAC username in the certificate sent by the client.
In the https://developer.couchbase.com/documentation/server/current/security/security-x509certsintro.html#story-h2-2[X.509 Certificates for Couchbase Server] instructions, you specified `commonName` as the field to use for the RBAC username.
Hence, the `commonName` field is set to `travel-sample`.
. Create a new file called *client.sh* with the following.
This script creates a new client certificate.
+
[source,bash]
----
export TOPDIR=SSLCA
export ROOT_DIR=rootdir
export NODE_DIR=nodedir
export INT_DIR=intdir

export CLIENT_INT_DIR=client_intdir
export CLIENT_CERT_DIR=client_certdir

cd ${TOPDIR}
mkdir ${CLIENT_INT_DIR}
mkdir ${CLIENT_CERT_DIR}

cd ${CLIENT_INT_DIR}
openssl genrsa -out int.key 2048
openssl req -new -key int.key -out int.csr -subj '/C=US/O=XYZ/CN=XYZIntCA'
cat <<EOF >> ./v3_ca.ext
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always
basicConstraints = CA:true
EOF
openssl x509 -req -in int.csr -CA ../${ROOT_DIR}/ca.pem -CAkey ../${ROOT_DIR}/ca.key \
-CAcreateserial -CAserial ../${ROOT_DIR}/rootCA.srl -extfile ./v3_ca.ext \
-out int.pem -days 365

cd ../${CLIENT_CERT_DIR}
openssl genrsa -out client.key 2048
openssl req -new -key client.key -out client.csr -config ../../ssl.conf
openssl x509 -req -in client.csr -CA ../${CLIENT_INT_DIR}/int.pem \
-CAkey ../${CLIENT_INT_DIR}/int.key \
-CAcreateserial -CAserial ../${CLIENT_INT_DIR}/intermediateCA.srl \
-out client.pem -days 365 \
-extfile ../../ssl.conf -extensions req_ext
cat client.pem ../${CLIENT_INT_DIR}/int.pem > chain.pem
----
. Run the script.
+
[source,bash]
----
$ ./client.sh
----
. Create a new file called *sync-gateway-config.json* with the following.
+
[source,json]
----
{
  "databases": {
    "db": {
      "server": "http://localhost:8091",
      "bucket": "default",
      "users": { "GUEST": { "disabled": false, "admin_channels": ["*"] } },
      "certpath": "./SSLCA/client_certdir/chain.pem",
      "keypath": "./SSLCA/client_certdir/client.key",
      "cacertpath": "./SSLCA/root/ca.pem"
    }
  }
}
----
As shown above, certificate based authentication on Sync Gateway is enabled with the following properties in the configuration file.
+
* xref:config-properties.adoc#databases-foo_db-certpath[databases.$db.certpath]
* xref:config-properties.adoc#databases-foo_db-keypath[databases.$db.keypath]
* xref:config-properties.adoc#databases-foo_db-cacertpath[databases.$db.cacertpath]
+
If the **username**/**password** properties are also specified in the configuration file then Sync Gateway will use password-based authentication and also include the client certificate in the TLS handshake.

== Continuous Logging

Continuous logging is a new feature in Sync Gateway 2.1 that provides more flexibility in how logs are generated and retained, whilst maintaining the level of logging required by Couchbase Support for investigation of issues.

Sync Gateway logging is now written to separate files by log level, with each log level supporting individual retention policies.

Console logging can also be configured independently, providing additional flexibility for system administrators depending on their needs.

The previous logging configuration (`logging.default`) is being deprecated, and Sync Gateway 2.1 will display warnings on startup of what is required to update your configuration.
Detailed information about continuous logging can be found in the xref:logging.adoc[Logging guide].

=== SGCollect Info

xref:sgcollect-info.adoc[`sgcollect_info`] has been updated to use the continuous logging feature introduced in 2.1, and collects the four leveled files (*sg_error.log*, *sg_warn.log*, *sg_info.log* and *sg_debug.log*).

These new log files are rotated and compressed by Sync Gateway, so `sgcollect_info` decompresses these rotated logs, and concatenates them back into a single file upon collection.

For example, if you have *sg_debug.log*, and *sg_debug-2018-04-23T16-57-13.218.log.gz* and then run `sgcollect_info` as normal, both of these files get put into a *sg_debug.log* file inside the zip output folder.

== Log Redaction

All log outputs can be redacted, this means that user-data, considered to be private, is removed.
This feature is optional and can be enabled in the configuration with the xref:config-properties.adoc#logging-redaction_level[`logging.redaction_level`] property.

=== SGCollect Info

`sgcollect_info` now supports log redaction post-processing.
In order to utilize this, Sync Gateway needs to be run with the `logging.redaction_level` property set to "partial".

Two new command line options have been added to `sgcollect_info`:

* `--log-redaction-level=REDACT_LEVEL`: redaction level for the logs collected, `none` and `partial` supported. Defaults to `none`.
+
When `--log-redaction-level` is set to partial, two zip files are produced, and tagged contents in the redacted one should be hashed in the same way as `cbcollect_info`:
+
[source,bash]
----
$ ./sgcollect_info --log-redaction-level=partial sgout.zip
...
Zipfile built: sgout-redacted.zip
Zipfile built: sgout.zip
----

* `--log-redaction-salt=SALT_VALUE`: salt used in the hashing of tagged data when enabling redaction. Defaults to a random uuid.

== Bucket operation timeout

The xref:config-properties.adoc#databases-foo_db-bucket_op_timeout_ms[`databases.$db.bucket_op_timeout_ms`] property to override the default timeout used by Sync Gateway to query Couchbase Server.
It's generally not necessary to change this property unless there is a particularly heavy load on Couchbase Server which would increase the response time.

== Support for IPv6

Sync Gateway now officially supports IPv6.

== Release Notes

This release contains a number of bug fixes and enhancements for Sync Gateway.
Find out more in the release notes.

xref:release-notes.adoc[Release Notes]
